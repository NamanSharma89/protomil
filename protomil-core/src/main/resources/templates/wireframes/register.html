<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">User Registration - Protomil</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.1" integrity="sha384-QWGpdj554B4ETpJJC9z+ZHJcA/i59TyjxEPXiiUgN2WmTyV5OEZWCD6gQhgkdpB/" crossorigin="anonymous"></script>

    <style>
        .protomil-brand {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .registration-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .htmx-indicator {
            opacity: 0;
            transition: opacity 500ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .validation-feedback {
            min-height: 1.2rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg protomil-brand">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/wireframes/">Protomil Core</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link text-white" href="/wireframes/">‚Üê Back to Home</a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card registration-card">
                <div class="card-header protomil-brand text-center">
                    <h4 class="mb-0">User Registration</h4>
                    <small>Join the Protomil platform</small>
                </div>

                <!-- Main Content Area -->
                <div id="main-content" class="card-body p-4">
                    <div th:replace="~{wireframes/register :: main-content}"></div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="text-center mt-4">
                <small class="text-muted">
                    Already have an account? <a href="/login">Sign in here</a>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Fragment for HTMX -->
<div th:fragment="main-content">
    <!-- Messages Section -->
    <div id="messages-section">
        <!-- Success Message -->
        <div th:if="${registrationSuccess == true}">
            <div th:replace="~{fragments/registration-errors :: success-message}"></div>
        </div>

        <!-- Error Messages -->
        <div th:if="${hasErrors == true}">
            <!-- Validation Errors -->
            <div th:if="${fieldErrors != null and !fieldErrors.isEmpty()}">
                <div th:replace="~{fragments/registration-errors :: validation-errors}"></div>
            </div>

            <!-- Business/General Errors -->
            <div th:if="${errorMessage != null and (fieldErrors == null or fieldErrors.isEmpty())}">
                <div th:replace="~{fragments/registration-errors :: business-error}"></div>
            </div>
        </div>
    </div>

    <!-- Registration Form -->
    <div th:if="${registrationSuccess != true}">
        <form th:action="@{/wireframes/register}"
              method="post"
              th:object="${userRegistration}"
              hx-post="/wireframes/register"
              hx-target="#main-content"
              hx-indicator="#loading-indicator"
              class="position-relative"
              novalidate>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="htmx-indicator">
                <div class="d-flex justify-content-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="firstName" class="form-label">First Name *</label>
                    <input type="text"
                           class="form-control"
                           th:classappend="${fieldErrors != null and fieldErrors.containsKey('firstName')} ? 'is-invalid' : ''"
                           id="firstName"
                           th:field="*{firstName}"
                           placeholder="Enter your first name"
                           required>
                    <div class="invalid-feedback" th:if="${fieldErrors != null and fieldErrors.containsKey('firstName')}"
                         th:text="${fieldErrors.firstName}"></div>
                </div>
                <div class="col-md-6">
                    <label for="lastName" class="form-label">Last Name *</label>
                    <input type="text"
                           class="form-control"
                           th:classappend="${fieldErrors != null and fieldErrors.containsKey('lastName')} ? 'is-invalid' : ''"
                           id="lastName"
                           th:field="*{lastName}"
                           placeholder="Enter your last name"
                           required>
                    <div class="invalid-feedback" th:if="${fieldErrors != null and fieldErrors.containsKey('lastName')}"
                         th:text="${fieldErrors.lastName}"></div>
                </div>
            </div>

            <!-- Email -->
            <div class="mt-3">
                <label for="email" class="form-label">Email Address *</label>
                <input type="email"
                       class="form-control"
                       th:classappend="${fieldErrors != null and fieldErrors.containsKey('email')} ? 'is-invalid' : ''"
                       id="email"
                       th:field="*{email}"
                       placeholder="name@company.com"
                       hx-post="/wireframes/validate-email"
                       hx-trigger="blur"
                       hx-target="#email-feedback"
                       hx-include="[name='email']"
                       required>
                <div id="email-feedback" class="validation-feedback">
                    <div class="invalid-feedback" th:if="${fieldErrors != null and fieldErrors.containsKey('email')}"
                         th:text="${fieldErrors.email}"></div>
                </div>
            </div>

            <!-- Phone Number -->
            <div class="mt-3">
                <label for="phoneNumber" class="form-label">Phone Number *</label>
                <input type="tel"
                       class="form-control"
                       th:classappend="${fieldErrors != null and fieldErrors.containsKey('phoneNumber')} ? 'is-invalid' : ''"
                       id="phoneNumber"
                       th:field="*{phoneNumber}"
                       placeholder="+919876543210"
                       hx-post="/wireframes/validate-phone"
                       hx-trigger="blur"
                       hx-target="#phone-feedback"
                       hx-include="[name='phoneNumber']"
                       required>
                <div id="phone-feedback" class="validation-feedback">
                    <div class="invalid-feedback" th:if="${fieldErrors != null and fieldErrors.containsKey('phoneNumber')}"
                         th:text="${fieldErrors.phoneNumber}"></div>
                </div>
            </div>

            <!-- Password -->
            <div class="mt-3">
                <label for="password" class="form-label">Password *</label>
                <input type="password"
                       class="form-control"
                       th:classappend="${fieldErrors != null and fieldErrors.containsKey('password')} ? 'is-invalid' : ''"
                       id="password"
                       th:field="*{password}"
                       placeholder="Enter a strong password"
                       hx-post="/wireframes/check-password-strength"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#password-feedback"
                       hx-include="[name='password']"
                       required>
                <div id="password-feedback" class="validation-feedback">
                    <div class="invalid-feedback" th:if="${fieldErrors != null and fieldErrors.containsKey('password')}"
                         th:text="${fieldErrors.password}"></div>
                </div>
            </div>

            <!-- Optional Fields -->
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <label for="employeeId" class="form-label">Employee ID</label>
                    <input type="text"
                           class="form-control"
                           id="employeeId"
                           th:field="*{employeeId}"
                           placeholder="Employee ID (optional)">
                </div>
                <div class="col-md-6">
                    <label for="department" class="form-label">Department</label>
                    <select class="form-select"
                            id="department"
                            th:field="*{department}">
                        <option value="">Select Department</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Quality">Quality Control</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Production">Production</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Admin">Administration</option>
                    </select>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="mt-4">
                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           id="agreeTerms"
                           name="agreeTerms"
                           required>
                    <label class="form-check-label" for="agreeTerms">
                        I agree to the <a href="#" target="_blank">Terms of Service</a>
                        and <a href="#" target="_blank">Privacy Policy</a> *
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <span class="htmx-indicator spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Register Account
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
    // Auto-format phone number
    document.addEventListener('DOMContentLoaded', function() {
        function setupPhoneFormatting(inputId) {
            const phoneInput = document.getElementById(inputId);
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.startsWith('91') && value.length <= 12) {
                        value = '+' + value;
                    } else if (!value.startsWith('+') && value.length === 10) {
                        value = '+91' + value;
                    }
                    e.target.value = value;
                });
            }
        }

        setupPhoneFormatting('phoneNumber');
    });

    // Listen for HTMX events
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'main-content') {
            // Re-setup phone formatting after HTMX swap
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                setupPhoneFormatting('phoneNumber');
            }
        }
    });
</script>
</body>
</html>